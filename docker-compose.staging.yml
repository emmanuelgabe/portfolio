# Docker Compose override for STAGING environment
# Usage: docker-compose -f docker-compose.yml -f docker-compose.staging.yml up -d

services:
  angular-frontend:
    container_name: portfolio-frontend-staging
    image: portfolio-angular-frontend:staging
    environment:
      - NODE_ENV=staging

  spring-backend:
    container_name: portfolio-backend-staging
    image: portfolio-spring-backend:staging
    environment:
      - SPRING_PROFILES_ACTIVE=staging
      - SPRING_DATASOURCE_URL=jdbc:postgresql://portfolio-db:5432/portfolio_staging
      - SPRING_DATASOURCE_USERNAME=postgres_app
      - SPRING_DATASOURCE_PASSWORD=${DB_USER_PASSWORD}
      - REDIS_HOST=redis-cache
      - REDIS_PORT=6379
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_APP_PASSWORD=${MAIL_APP_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - ADMIN_PASSWORD_HASH=${ADMIN_PASSWORD_HASH}
    volumes:
      - portfolio_uploads_staging:/app/uploads
    depends_on:
      portfolio-db:
        condition: service_healthy
      redis-cache:
        condition: service_healthy

  portfolio-db:
    container_name: portfolio-db-staging
    # No exposed ports in staging - database accessible only via Docker internal network
    # Use 'docker exec portfolio-db-staging psql -U postgres_app -d portfolio_staging' for debugging
    environment:
      POSTGRES_DB: portfolio_staging
      POSTGRES_USER: postgres_app
      POSTGRES_PASSWORD: ${DB_USER_PASSWORD}
    volumes:
      - portfolio_db_staging_data:/var/lib/postgresql/data

  redis-cache:
    container_name: portfolio-redis-staging
    ports:
      - "6380:6379"  # Expose staging Redis on different port
    volumes:
      - portfolio_redis_staging_data:/data

  nginx-portfolio:
    container_name: portfolio-nginx-staging
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d/staging.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "3000:80"  # Staging accessible on port 3000

volumes:
  portfolio_db_staging_data:
    name: portfolio_staging_db_data
  portfolio_uploads_staging:
    name: portfolio_staging_uploads
  portfolio_redis_staging_data:
    name: portfolio_staging_redis_data