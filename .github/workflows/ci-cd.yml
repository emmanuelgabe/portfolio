name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - staging
      - develop
      - 'dev/**'
  pull_request:
    branches:
      - main
      - staging

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  build-and-test:
    runs-on: self-hosted
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from Git tags
        id: version
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "0.0.1-SNAPSHOT")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
        working-directory: portfolio-backend

      - name: Build Backend with Gradle
        run: ./gradlew clean bootJar -x test
        working-directory: portfolio-backend

      # Tests disabled for now - Uncomment to enable
      # - name: Run Backend Tests
      #   run: ./gradlew test
      #   working-directory: portfolio-backend

      # - name: Test Report
      #   uses: dorny/test-reporter@v1
      #   if: always()
      #   with:
      #     name: Backend Test Results
      #     path: portfolio-backend/build/test-results/test/*.xml
      #     reporter: java-junit

  deploy:
    runs-on: self-hosted
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
    environment:
      name: ${{ github.ref_name == 'main' && 'production' || 'staging' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set deployment variables
        id: deploy-vars
        run: |
          if [ "$GITHUB_REF_NAME" == "main" ]; then
            echo "ENV_NAME=prod" >> $GITHUB_OUTPUT
            echo "COMPOSE_FILE=docker-compose.prod.yml" >> $GITHUB_OUTPUT
            echo "DEPLOY_PATH=/home/manu/projects/portfolio/prod" >> $GITHUB_OUTPUT
          else
            echo "ENV_NAME=staging" >> $GITHUB_OUTPUT
            echo "COMPOSE_FILE=docker-compose.staging.yml" >> $GITHUB_OUTPUT
            echo "DEPLOY_PATH=/home/manu/projects/portfolio/staging" >> $GITHUB_OUTPUT
          fi

      - name: Clean and prepare deployment directory
        run: |
          DEPLOY_PATH="${{ steps.deploy-vars.outputs.DEPLOY_PATH }}"

          # Remove old deployment directory to avoid permission conflicts
          rm -rf "$DEPLOY_PATH"

          # Create fresh deployment directory
          mkdir -p "$DEPLOY_PATH"

      - name: Copy artifacts to deployment folder
        run: |
          DEPLOY_PATH="${{ steps.deploy-vars.outputs.DEPLOY_PATH }}"

          # Copy .git for version generation (required for frontend)
          cp -r .git "$DEPLOY_PATH/"

          # Copy source files
          cp -r portfolio-backend "$DEPLOY_PATH/"
          cp -r portfolio-frontend "$DEPLOY_PATH/"
          cp -r nginx "$DEPLOY_PATH/"

          # Copy Docker Compose files
          cp docker-compose.yml "$DEPLOY_PATH/"
          cp ${{ steps.deploy-vars.outputs.COMPOSE_FILE }} "$DEPLOY_PATH/"

      - name: Cleanup old containers and images
        run: |
          ENV_NAME="${{ steps.deploy-vars.outputs.ENV_NAME }}"

          echo "Stopping and removing old containers for $ENV_NAME environment..."
          docker ps -a --filter "name=portfolio.*-$ENV_NAME" --format "{{.Names}}" | xargs -r docker stop || true
          docker ps -a --filter "name=portfolio.*-$ENV_NAME" --format "{{.Names}}" | xargs -r docker rm || true

          echo "Cleaning up dangling images..."
          docker image prune -f

      - name: Deploy with Docker Compose
        working-directory: ${{ steps.deploy-vars.outputs.DEPLOY_PATH }}
        run: |
          COMPOSE_FILE="${{ steps.deploy-vars.outputs.COMPOSE_FILE }}"
          ENV_NAME="${{ steps.deploy-vars.outputs.ENV_NAME }}"
          VERSION="${{ needs.build-and-test.outputs.version }}"

          echo "Building and starting containers with version: $VERSION..."
          DB_USER_PASSWORD=${{ secrets.DB_PASSWORD }} \
          VERSION=$VERSION \
            docker-compose -p portfolio-$ENV_NAME -f docker-compose.yml -f "$COMPOSE_FILE" up --build -d

          echo "Containers started, waiting for health checks..."

      - name: Wait for containers to be healthy
        working-directory: ${{ steps.deploy-vars.outputs.DEPLOY_PATH }}
        run: |
          ENV_NAME="${{ steps.deploy-vars.outputs.ENV_NAME }}"
          MAX_ATTEMPTS=60
          ATTEMPT=0

          echo "Waiting for all containers to reach healthy status..."

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))

            # Check if containers exist and are running
            DB_EXISTS=$(docker ps -q --filter "name=portfolio-db-$ENV_NAME" 2>/dev/null)
            BACKEND_EXISTS=$(docker ps -q --filter "name=portfolio-backend-$ENV_NAME" 2>/dev/null)
            FRONTEND_EXISTS=$(docker ps -q --filter "name=portfolio-frontend-$ENV_NAME" 2>/dev/null)
            NGINX_EXISTS=$(docker ps -q --filter "name=portfolio-nginx-$ENV_NAME" 2>/dev/null)

            # Check health status (only for containers with healthcheck)
            if [ -n "$DB_EXISTS" ]; then
              DB_HEALTH=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}running{{end}}' portfolio-db-$ENV_NAME 2>/dev/null)
            else
              DB_HEALTH="not_running"
            fi

            if [ -n "$BACKEND_EXISTS" ]; then
              BACKEND_HEALTH=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}running{{end}}' portfolio-backend-$ENV_NAME 2>/dev/null)
            else
              BACKEND_HEALTH="not_running"
            fi

            if [ -n "$FRONTEND_EXISTS" ]; then
              FRONTEND_HEALTH=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}running{{end}}' portfolio-frontend-$ENV_NAME 2>/dev/null)
            else
              FRONTEND_HEALTH="not_running"
            fi

            if [ -n "$NGINX_EXISTS" ]; then
              NGINX_HEALTH="running"
            else
              NGINX_HEALTH="not_running"
            fi

            echo "[$ATTEMPT/$MAX_ATTEMPTS] DB: $DB_HEALTH | Backend: $BACKEND_HEALTH | Frontend: $FRONTEND_HEALTH | Nginx: $NGINX_HEALTH"

            # Check if all are healthy or running
            if [ "$DB_HEALTH" = "healthy" ] && [ "$BACKEND_HEALTH" = "healthy" ] && [ "$FRONTEND_HEALTH" = "healthy" ] && [ "$NGINX_HEALTH" = "running" ]; then
              echo "[SUCCESS] All containers are healthy!"
              exit 0
            fi

            # Check for unhealthy or not running containers
            if [ "$DB_HEALTH" = "unhealthy" ] || [ "$BACKEND_HEALTH" = "unhealthy" ] || [ "$FRONTEND_HEALTH" = "unhealthy" ]; then
              echo "[ERROR] One or more containers are unhealthy!"
              echo "Showing container logs..."
              [ "$DB_HEALTH" = "unhealthy" ] && docker logs --tail=50 portfolio-db-$ENV_NAME
              [ "$BACKEND_HEALTH" = "unhealthy" ] && docker logs --tail=50 portfolio-backend-$ENV_NAME
              [ "$FRONTEND_HEALTH" = "unhealthy" ] && docker logs --tail=50 portfolio-frontend-$ENV_NAME
              exit 1
            fi

            if [ "$DB_HEALTH" = "not_running" ] || [ "$BACKEND_HEALTH" = "not_running" ] || [ "$FRONTEND_HEALTH" = "not_running" ] || [ "$NGINX_HEALTH" = "not_running" ]; then
              echo "[WARN] Some containers are not running yet, waiting..."
              docker ps -a --filter "name=portfolio.*-$ENV_NAME"
            fi

            sleep 5
          done

          echo "[ERROR] Timeout waiting for containers to be healthy"
          echo "Final status - DB: $DB_HEALTH | Backend: $BACKEND_HEALTH | Frontend: $FRONTEND_HEALTH | Nginx: $NGINX_HEALTH"
          echo ""
          echo "Container status:"
          docker ps -a --filter "name=portfolio.*-$ENV_NAME"
          echo ""
          echo "Container logs:"
          docker logs --tail=50 portfolio-db-$ENV_NAME 2>&1 || true
          docker logs --tail=50 portfolio-backend-$ENV_NAME 2>&1 || true
          docker logs --tail=50 portfolio-frontend-$ENV_NAME 2>&1 || true
          docker logs --tail=50 portfolio-nginx-$ENV_NAME 2>&1 || true
          exit 1

      - name: Tag Docker images with version
        run: |
          VERSION=${{ needs.build-and-test.outputs.version }}
          ENV_NAME="${{ steps.deploy-vars.outputs.ENV_NAME }}"

          echo "Tagging images with version: $VERSION"

          # Tag backend image
          BACKEND_IMAGE=$(docker ps --filter "name=portfolio-backend-$ENV_NAME" --format "{{.Image}}")
          if [ -n "$BACKEND_IMAGE" ]; then
            docker tag "$BACKEND_IMAGE" "portfolio-backend:$VERSION"
            docker tag "$BACKEND_IMAGE" "portfolio-backend:latest"
            docker tag "$BACKEND_IMAGE" "portfolio-backend:$ENV_NAME-latest"
            echo "Tagged backend: portfolio-backend:$VERSION"
          fi

          # Tag frontend image
          FRONTEND_IMAGE=$(docker ps --filter "name=portfolio-frontend-$ENV_NAME" --format "{{.Image}}")
          if [ -n "$FRONTEND_IMAGE" ]; then
            docker tag "$FRONTEND_IMAGE" "portfolio-frontend:$VERSION"
            docker tag "$FRONTEND_IMAGE" "portfolio-frontend:latest"
            docker tag "$FRONTEND_IMAGE" "portfolio-frontend:$ENV_NAME-latest"
            echo "Tagged frontend: portfolio-frontend:$VERSION"
          fi

      - name: Smoke tests
        run: |
          ENV_NAME="${{ steps.deploy-vars.outputs.ENV_NAME }}"

          # Determine the port based on environment
          if [ "$ENV_NAME" = "prod" ]; then
            PORT=80
          else
            PORT=3000
          fi

          echo "Running smoke tests on port $PORT..."

          # Test 1: Frontend health endpoint
          echo "Testing frontend health endpoint..."
          FRONTEND_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$PORT/health.json || echo "000")
          if [ "$FRONTEND_HEALTH" = "200" ]; then
            echo "[SUCCESS] Frontend health check passed"
          else
            echo "[ERROR] Frontend health check failed (HTTP $FRONTEND_HEALTH)"
            exit 1
          fi

          # Test 2: Backend actuator health endpoint
          echo "Testing backend actuator health endpoint..."
          if docker exec portfolio-backend-$ENV_NAME wget --quiet --spider http://localhost:8080/actuator/health >/dev/null 2>&1; then
            echo "[SUCCESS] Backend actuator health check passed"
          else
            echo "[ERROR] Backend actuator health check failed"
            exit 1
          fi

          # Test 3: Database connectivity
          echo "Testing database connectivity..."
          if [ "$ENV_NAME" = "prod" ]; then
            DB_NAME="portfolio_prod"
          else
            DB_NAME="portfolio_staging"
          fi
          DB_TEST=$(docker exec portfolio-db-$ENV_NAME psql -U postgres_app -d $DB_NAME -c "SELECT 1;" 2>&1)
          if echo "$DB_TEST" | grep -q "1 row"; then
            echo "[SUCCESS] Database connectivity test passed"
          else
            echo "[ERROR] Database connectivity test failed"
            echo "$DB_TEST"
            exit 1
          fi

          # Test 4: Full stack integration (nginx -> frontend)
          echo "Testing full stack integration..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$PORT/ || echo "000")
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "304" ]; then
            echo "[SUCCESS] Full stack integration test passed (HTTP $HTTP_STATUS)"
          else
            echo "[ERROR] Full stack integration test failed (HTTP $HTTP_STATUS)"
            exit 1
          fi

          echo ""
          echo "========================================="
          echo "[SUCCESS] All smoke tests passed!"
          echo "========================================="

      - name: Cleanup old images
        run: |
          echo "Cleaning up dangling images..."
          docker image prune -f

          echo "Removing unused volumes..."
          docker volume prune -f || true

      - name: Verify deployment
        run: |
          ENV_NAME="${{ steps.deploy-vars.outputs.ENV_NAME }}"

          echo "=== Running containers ==="
          docker ps --filter "name=portfolio.*-$ENV_NAME"

          echo ""
          echo "=== Container health status ==="
          docker ps --filter "name=portfolio.*-$ENV_NAME" --format "table {{.Names}}\t{{.Status}}"

          echo ""
          echo "=== Disk usage ==="
          docker system df

      - name: Deployment summary
        if: always()
        run: |
          ENV_NAME="${{ steps.deploy-vars.outputs.ENV_NAME }}"
          VERSION="${{ needs.build-and-test.outputs.version }}"

          echo "========================================="
          echo "Deployment Summary"
          echo "========================================="
          echo "Environment: $ENV_NAME"
          echo "Version: $VERSION"
          echo "Branch: $GITHUB_REF_NAME"
          echo "Commit: $GITHUB_SHA"
          echo "========================================="