# Docker Compose override for PRODUCTION environment
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  angular-frontend:
    container_name: portfolio-frontend-prod
    image: portfolio-angular-frontend:prod
    environment:
      - NODE_ENV=production
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M

  spring-backend:
    container_name: portfolio-backend-prod
    image: portfolio-spring-backend:prod
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://portfolio-db:5432/portfolio_prod
      - SPRING_DATASOURCE_USERNAME=postgres_app
      - SPRING_DATASOURCE_PASSWORD=${DB_USER_PASSWORD}
      - REDIS_HOST=redis-cache
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:?RABBITMQ_USERNAME required in production}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:?RABBITMQ_PASSWORD required in production}
      - RABBITMQ_ENABLED=true
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_APP_PASSWORD=${MAIL_APP_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - ADMIN_PASSWORD_HASH=${ADMIN_PASSWORD_HASH}
      - SENTRY_DSN=${SENTRY_DSN}
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_ENABLED=${KAFKA_ENABLED:-true}
      - ELASTICSEARCH_HOST=elasticsearch
      - ELASTICSEARCH_PORT=9200
      - ELASTICSEARCH_ENABLED=${ELASTICSEARCH_ENABLED:-true}
    volumes:
      - portfolio_uploads_prod:/app/uploads
    depends_on:
      portfolio-db:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      kafka:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          memory: 512M

  portfolio-db:
    container_name: portfolio-db-prod
    # No exposed ports in production - database accessible only via Docker internal network
    environment:
      POSTGRES_DB: portfolio_prod
      POSTGRES_USER: postgres_app
      POSTGRES_PASSWORD: ${DB_USER_PASSWORD}
    volumes:
      - portfolio_db_prod_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          memory: 256M

  redis-cache:
    container_name: portfolio-redis-prod
    command: redis-server --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD required in production}
    # No exposed port in production (internal network only)
    volumes:
      - portfolio_redis_prod_data:/data
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 64M

  rabbitmq:
    container_name: portfolio-rabbitmq-prod
    # No exposed ports in production (internal network only)
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME:?RABBITMQ_USERNAME required in production}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:?RABBITMQ_PASSWORD required in production}
    volumes:
      - portfolio_rabbitmq_prod_data:/var/lib/rabbitmq
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M

  nginx-portfolio:
    container_name: portfolio-nginx-prod
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d/prod.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "80:80"  # Production accessible on standard HTTP port
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          memory: 64M

  kafka:
    container_name: portfolio-kafka-prod

  elasticsearch:
    container_name: portfolio-elasticsearch-prod

volumes:
  portfolio_db_prod_data:
    name: portfolio_prod_db_data
  portfolio_uploads_prod:
    name: portfolio_prod_uploads
  portfolio_redis_prod_data:
    name: portfolio_prod_redis_data
  portfolio_rabbitmq_prod_data:
    name: portfolio_prod_rabbitmq_data